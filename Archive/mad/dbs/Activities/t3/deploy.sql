/* Despliegue completo de la base de datos */

USE 23_db_Daniel;

-- Categorías de trabajador
CREATE TABLE IF NOT EXISTS P3_CAT(
	ID			INT	UNSIGNED	NOT NULL	AUTO_INCREMENT,
	nombreCat	VARCHAR(50)		NOT NULL,
	PRIMARY KEY (ID)
	);

-- Grupos de cotización
CREATE TABLE IF NOT EXISTS P3_COT(
	ID		INT UNSIGNED	NOT NULL	AUTO_INCREMENT,
	grupo	VARCHAR(20)		NOT NULL,
	PRIMARY KEY (ID)
	);

-- Empresas
CREATE TABLE IF NOT EXISTS P3_EMPRESA(
	CIF		VARCHAR(9)			NOT NULL,
	nombre	VARCHAR(50)			NOT NULL,
	dir		VARCHAR(50)			NULL,
	cp		VARCHAR(5)			NULL,
	prov	VARCHAR(20)			NULL,
	ccc		BIGINT(11) UNSIGNED	NOT NULL,
	tlf		INT(9) UNSIGNED		NULL,
	PRIMARY KEY (CIF)
	);

-- Trabajadores
CREATE TABLE IF NOT EXISTS P3_TRABAJADOR(
	NIF		VARCHAR(9)			NOT NULL,
	nombre	VARCHAR(20)			NOT NULL,
	ape1	VARCHAR(20)			NOT NULL,
	ape2	VARCHAR(20)			NULL,
	tlf		INT(9) UNSIGNED		NULL,
	nss		BIGINT(11) UNSIGNED	NOT NULL,
	catID	INT UNSIGNED		NULL,
	cotID	INT UNSIGNED		NOT NULL,
	PRIMARY KEY (NIF)
	);

-- Tipos de contrato
CREATE TABLE IF NOT EXISTS P3_TCONTRATO(
	codContrato	INT UNSIGNED	NOT NULL	AUTO_INCREMENT,
	nombre		VARCHAR(50)		NULL,
	PRIMARY KEY (codContrato)
	);

-- Contratos
CREATE TABLE IF NOT EXISTS P3_CONTRATO(
	numContrato	INT UNSIGNED	NOT NULL	AUTO_INCREMENT,
	fAlta		DATE			NOT NULL,
	fBaja		DATE			NULL,
	codContrato	INT UNSIGNED	NOT NULL,
	NIF			VARCHAR(9)		NOT NULL,
	CIF			VARCHAR(9)		NOT NULL,
	PRIMARY KEY (numContrato)
	);

-- Tipos de concepto
CREATE TABLE IF NOT EXISTS P3_CONCTIPO(
	conTipo	INT UNSIGNED	NOT NULL	AUTO_INCREMENT,
	nombre	VARCHAR(20)		NULL,
	tipo	TINYINT(1)		NOT NULL, -- Donde 0 es no salarial y 1 es salarial (optimización)
	PRIMARY KEY (conTipo)
	);

-- Relación concepto - salario
CREATE TABLE IF NOT EXISTS P3_CONCSALARIO(
	ID			INT UNSIGNED	NOT NULL	AUTO_INCREMENT,
	numContrato	INT UNSIGNED	NOT NULL,
	conTipo		INT UNSIGNED	NOT NULL,
	cantidad	INT UNSIGNED	NOT NULL,
	PRIMARY KEY (ID)
	);

-- Tipos de bases
CREATE TABLE IF NOT EXISTS P3_BASESTIPOS(
	ID			INT UNSIGNED	NOT NULL	AUTO_INCREMENT,
	nombre		VARCHAR(20)		NULL,
	porcentaje	TINYINT			NOT NULL,
	PRIMARY KEY (ID)
	);

-- Bases de cotización
CREATE TABLE P3_BASESCOT(
	ID			INT UNSIGNED	NOT NULL	AUTO_INCREMENT,
	numContrato	INT UNSIGNED	NOT NULL,
	cantidad	INT UNSIGNED	NOT NULL,
	PRIMARY KEY (ID)
	);

-- Tipos de deducción
CREATE TABLE IF NOT EXISTS P3_TIPOSDEDUCCION(
	tipoDeduccion	INT UNSIGNED	NOT NULL	 AUTO_INCREMENT,
	nombre			VARCHAR(20)		NULL,
	receptor		VARCHAR(20)		NOT NULL,
	PRIMARY KEY (tipoDeduccion)
	);

-- Deducción
CREATE TABLE IF NOT EXISTS P3_DEDUCCION(
	ID				INT UNSIGNED			NOT NULL	AUTO_INCREMENT,
	tipoDeduccion	INT UNSIGNED			NOT NULL,
	anho			SMALLINT(4) UNSIGNED	NOT NULL,
	mes				TINYINT(2) UNSIGNED		NOT NULL,
	NIF				VARCHAR(9)				NOT NULL,
	numContrato		INT UNSIGNED			NOT NULL,
	cantidad		INT UNSIGNED			NOT NULL,
	PRIMARY KEY (ID)
	);

/* Claves foráneas */

-- Trabajador
ALTER TABLE P3_TRABAJADOR
	ADD FOREIGN KEY (catID) REFERENCES P3_CAT(ID);
ALTER TABLE P3_TRABAJADOR
	ADD FOREIGN KEY (cotID) REFERENCES P3_COT (ID);

-- Contratos
ALTER TABLE P3_CONTRATO
	ADD FOREIGN KEY (codContrato) REFERENCES P3_TCONTRATO (codContrato);
ALTER TABLE P3_CONTRATO
	ADD FOREIGN KEY (NIF) REFERENCES P3_TRABAJADOR (NIF);
ALTER TABLE P3_CONTRATO
	ADD FOREIGN KEY (CIF) REFERENCES P3_EMPRESA (CIF);

-- Concepto salario
ALTER TABLE P3_CONCSALARIO
	ADD FOREIGN KEY (numContrato) REFERENCES P3_CONTRATO (numContrato);
ALTER TABLE P3_CONCSALARIO
	ADD FOREIGN KEY (conTipo) REFERENCES P3_CONCTIPO (conTipo);

-- Base de cotización
ALTER TABLE P3_BASESCOT
	ADD FOREIGN KEY (numContrato) REFERENCES P3_CONTRATO (numContrato);

-- Deducción
ALTER TABLE P3_DEDUCCION
	ADD FOREIGN KEY (tipoDeduccion) REFERENCES P3_TIPOSDEDUCCION (tipoDeduccion);
ALTER TABLE P3_DEDUCCION
	ADD FOREIGN KEY (NIF) REFERENCES P3_TRABAJADOR (NIF);
ALTER TABLE P3_DEDUCCION
	ADD FOREIGN KEY (numContrato) REFERENCES P3_CONTRATO (numContrato);

-- Listar tablas
SHOW TABLES LIKE "P3%";